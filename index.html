<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Papan Pesan Digital - Prof. Dr. H. Sukadiono, dr., MM.</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Prevent scrolling on the main body */
        }
        .main-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url('ProfSukoOverlay.png') no-repeat center center;
            background-size: cover;
        }
        .grid-gallery {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .grid-item {
            position: relative;
            aspect-ratio: 16 / 10;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0;
            transform: translateY(30px);
        }
        .grid-item:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.08);
        }
        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .grid-item.visible {
            animation: flyInUp 0.6s ease-out forwards;
        }
        @keyframes flyInUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .pagination-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .pagination-dot:hover { background-color: rgba(0, 0, 0, 0.4); }
        .pagination-dot.active { background-color: #003366; transform: scale(1.2); }
        #drawing-canvas {
            position: absolute;
            top: 11.1%;
            left: 28.1%;
            width: 65.1%;
            height: 74.1%;
            touch-action: none;
            border-radius: 1.5rem;
        }
        .toolbar-touch {
            position: absolute;
            bottom: 2%;
            left: 50%;
            transform: translate(-50%, 150%);
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: rgba(40, 40, 40, 0.9);
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 3;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .toolbar-touch.visible { transform: translate(-50%, 0); }
        .toolbar-touch .tool-group{display:flex;align-items:center;gap:.75rem}.toolbar-touch .separator{width:1px;height:40px;background-color:rgba(255,255,255,.2)}.tool-button,.color-swatch{width:56px;height:56px;border-radius:50%;border:2px solid transparent;cursor:pointer;display:flex;justify-content:center;align-items:center;transition:all .2s ease;background-color:rgba(255,255,255,.1)}.tool-button:hover,.color-swatch:hover{background-color:rgba(255,255,255,.2);transform:scale(1.1)}.tool-button.active,.color-swatch.active{border-color:#3b82f6;background-color:rgba(59,130,246,.3)}.color-swatch span{width:36px;height:36px;border-radius:50%;display:block;border:2px solid rgba(0,0,0,.2)}.brush-size-button span{display:block;background-color:#fff;border-radius:50%}.tool-button:disabled{opacity:.5;cursor:not-allowed;transform:scale(1) !important;background-color:rgba(255,255,255,.1) !important}
        #idle-screen {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            transition: opacity 0.8s ease;
            border-radius: 1.5rem;
            color: #333;
        }
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 2.5rem;
            background-color: #003366;
            animation: blink-caret .8s step-end infinite;
            vertical-align: bottom;
        }
        @keyframes blink-caret {
            from, to { background-color: transparent }
            50% { background-color: #003366; }
        }
        
        /* --- STYLE UNTUK MODE ADMIN --- */
        #admin-trigger {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 80px;
            height: 80px;
            z-index: 99;
            cursor: pointer;
        }
        #admin-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-in-out;
        }
        #admin-panel.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #admin-key-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #admin-key-btn:hover {
            background-color: rgba(40, 40, 40, 0.9);
            transform: scale(1.1);
        }
        #login-view {
            display: flex;
            gap: 8px;
            align-items: center;
            background-color: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(8px);
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            transform: translateX(-10px);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #login-view.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }
        #admin-panel input {
            background-color: #333;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #555;
        }
        #admin-panel button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
        }
        .admin-action-button {
            position: absolute;
            z-index: 2;
            width: 40px;
            height: 40px;
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .delete-button {
            top: 10px;
            right: 10px;
            background-color: rgba(239, 68, 68, 0.8);
            font-size: 20px;
            font-weight: bold;
        }
        .delete-button:hover {
            background-color: #ef4444;
            transform: scale(1.1);
        }
        .export-button {
            top: 10px;
            left: 10px;
            background-color: rgba(22, 163, 74, 0.8);
        }
        .export-button:hover {
            background-color: #16a34a;
            transform: scale(1.1);
        }
        .admin-mode .admin-action-button { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Main Container with Background -->
    <div class="main-container"></div>

    <!-- Gallery Section Wrapper -->
    <div id="gallery-section" class="absolute top-[11.1%] left-[28.1%] w-[65.1%] h-[74.1%]">
        <div class="grid-gallery" id="gallery">
            <!-- Pesan akan dimuat di sini oleh JavaScript -->
        </div>
        <div id="idle-screen" class="absolute inset-0 flex items-center justify-center p-12 opacity-0 pointer-events-none cursor-pointer">
            <div class="text-center">
                <h1 id="typing-heading" class="text-5xl font-bold mb-4" style="font-family: 'Playfair Display', serif;"></h1>
                <p class="text-xl mt-8 opacity-70">(Sentuh di mana saja untuk memulai)</p>
            </div>
        </div>
        <div id="bottom-controls" class="absolute bottom-[-80px] left-1/2 -translate-x-1/2 z-10 flex flex-col items-center gap-3 w-full">
            <div id="pagination-dots" class="flex gap-3 h-4 items-center"></div>
            <button id="open-canvas-btn" class="flex items-center gap-4 px-8 py-5 bg-blue-600 text-white text-2xl font-bold rounded-full shadow-2xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                Tulis Pesan
            </button>
        </div>
    </div>

    <!-- Canvas Section (hidden by default) -->
    <div id="canvas-container" class="hidden">
        <canvas id="drawing-canvas"></canvas>
        <div id="toolbar" class="toolbar-touch">
            <div class="tool-group" id="color-palette"></div><div class="separator"></div><div class="tool-group" id="brush-sizes"></div><div class="separator"></div><div class="tool-group"><button id="undo-btn" class="tool-button" title="Urungkan"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg></button><button id="clear-canvas-btn" class="tool-button" title="Hapus Goresan"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.54 21.46-5.3-5.3"/><path d="M11 21H5a2 2 0 0 1-2-2V7h14v4"/><path d="M3 7V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4"/><path d="M12.5 2.5 10.5 7h5l-2-4.5Z"/><path d="M18 13h-5"/><path d="m21.54 16.16-5.3 5.3"/></svg></button><button id="submit-btn" class="tool-button bg-green-500 hover:bg-green-600" title="Kirim Pesan"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2 11 13"/><path d="m22 2-7 20-4-9-9-4Z"/></svg></button><button id="close-canvas-btn" class="tool-button bg-red-500 hover:bg-red-600" title="Tutup Kanvas"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
        </div>
    </div>

    <!-- Modal for viewing a single message -->
    <div id="modal-view" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden items-center justify-center p-8 transition-opacity duration-300">
        <div class="relative w-full max-w-6xl max-h-full">
            <img id="modal-img" src="" alt="Preview Pesan" class="block w-full h-full object-contain">
            <button onclick="closeModal()" class="absolute -top-4 -right-4 w-14 h-14 bg-white text-black rounded-full text-2xl font-bold shadow-lg flex items-center justify-center">&times;</button>
        </div>
    </div>

    <!-- "Thank You" Toast Notification -->
    <div id="thank-you-toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-green-500 text-white px-8 py-4 rounded-full shadow-lg text-xl font-bold z-50 transition-all duration-500 opacity-0 -translate-y-20">
        Terima kasih! Pesan Anda telah disimpan.
    </div>

    <!-- Secret Admin Trigger Area -->
    <div id="admin-trigger"></div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel">
        <button id="admin-key-btn" title="Admin Login">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
        </button>
        <div id="login-view" class="hidden">
            <input type="password" id="admin-password" placeholder="Password Admin" />
            <button id="login-btn">Login</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const gallery = document.getElementById('gallery');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const gallerySection = document.getElementById('gallery-section');
        const canvasContainer = document.getElementById('canvas-container');
        const openCanvasBtn = document.getElementById('open-canvas-btn');
        const modalView = document.getElementById('modal-view');
        const modalImg = document.getElementById('modal-img');
        const paginationDotsContainer = document.getElementById('pagination-dots');
        const thankYouToast = document.getElementById('thank-you-toast');
        const idleScreen = document.getElementById('idle-screen');
        const typingHeading = document.getElementById('typing-heading');
        const bottomControls = document.getElementById('bottom-controls');
        const body = document.body;
        const toolbar = document.getElementById('toolbar');
        
        // --- Admin Elements ---
        const adminTrigger = document.getElementById('admin-trigger');
        const adminPanel = document.getElementById('admin-panel');
        const adminKeyBtn = document.getElementById('admin-key-btn');
        const adminPasswordInput = document.getElementById('admin-password');
        const loginBtn = document.getElementById('login-btn');
        const loginView = document.getElementById('login-view');

        // --- State ---
        let isAdmin = false;
        let adminPassword = '';
        let drawing = false;
        let brushSize = 10;
        let brushColor = '#000000';
        let slideshowInterval;
        let currentPage = 0;
        const NOTES_PER_PAGE = 12;
        const SLIDESHOW_DELAY = 15000;
        let historyStack = [];
        let idleTimer;
        const IDLE_TIMEOUT = 30000;

        // --- Admin Logic ---
        let adminClickCount = 0;
        let adminClickTimer;

        adminTrigger.addEventListener('click', () => {
            // If the panel is already visible, hide it and log out
            if (adminPanel.classList.contains('visible')) {
                adminPanel.classList.remove('visible');
                if (isAdmin) {
                    toggleAdminMode(false);
                }
                return;
            }

            // Otherwise, run the triple-click logic
            adminClickCount++;
            clearTimeout(adminClickTimer);

            if (adminClickCount >= 3) {
                adminPanel.classList.add('visible');
                adminClickCount = 0;
            } else {
                adminClickTimer = setTimeout(() => {
                    adminClickCount = 0;
                }, 1500); // User has 1.5s between clicks
            }
        });

        function toggleAdminMode(loggedIn) {
            isAdmin = loggedIn;
            body.classList.toggle('admin-mode', loggedIn);
            loginView.classList.remove('visible'); 
            if (!loggedIn) {
                adminPasswordInput.value = '';
                adminPassword = '';
                // Also hide the panel on logout/failure
                adminPanel.classList.remove('visible');
            }
            renderPage();
        }
        
        adminKeyBtn.addEventListener('click', () => {
            loginView.classList.toggle('visible');
        });

        loginBtn.addEventListener('click', () => {
            if (adminPasswordInput.value) {
                adminPassword = adminPasswordInput.value;
                toggleAdminMode(true);
            } else {
                alert('Silakan masukkan password.');
            }
        });

        async function deleteNote(noteId) {
            if (!isAdmin || !adminPassword) {
                alert('Mode admin tidak aktif.');
                return;
            }
            if (!confirm(`Anda yakin ingin menghapus pesan ini?`)) return;

            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: noteId, secret: adminPassword })
                });

                if (response.ok) {
                    alert('Pesan berhasil dihapus!');
                    renderPage();
                } else {
                    const errorData = await response.json();
                    if (response.status === 401) {
                        alert(`Gagal menghapus: Password salah.`);
                        toggleAdminMode(false);
                    } else {
                        alert(`Gagal menghapus: ${errorData.error}`);
                    }
                }
            } catch (error) {
                alert('Terjadi kesalahan jaringan.');
            }
        }

        // --- Export Single Image Logic ---
        async function exportSingleImage(imageUrl, noteId) {
            try {
                // Fetch the image data as a blob to bypass potential CORS issues for download
                const response = await fetch(imageUrl);
                if (!response.ok) throw new Error('Network response was not ok.');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                // Create a cleaner filename
                const filename = `pesan-${noteId.replace('notes/', '').replace('.png', '')}.png`;
                link.download = filename;
                
                // Append to body to ensure it's clickable, click, and then remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Clean up the object URL
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Gagal mengunduh gambar:', error);
                alert('Gagal mengunduh gambar. Anda bisa coba klik kanan pada gambar dan pilih "Simpan Gambar Sebagai..."');
            }
        }

        // --- API & Rendering Logic ---
        async function fetchNotes() {
            try {
                const response = await fetch('/api/notes');
                if (!response.ok) return [];
                const data = await response.json();
                return data.notes || [];
            } catch (error) {
                console.error("Gagal mengambil pesan:", error);
                return [];
            }
        }

        async function renderPage() {
            clearInterval(slideshowInterval);
            const allNotes = await fetchNotes();
            gallery.innerHTML = '';
            paginationDotsContainer.innerHTML = '';

            if (allNotes.length === 0) {
                paginationDotsContainer.style.display = 'none';
                startSlideshow(0);
                return;
            }
            
            paginationDotsContainer.style.display = 'flex';
            const pageCount = Math.ceil(allNotes.length / NOTES_PER_PAGE);
            if (currentPage >= pageCount) currentPage = Math.max(0, pageCount - 1);
            
            const start = currentPage * NOTES_PER_PAGE;
            const end = start + NOTES_PER_PAGE;
            const notesToDisplay = allNotes.slice(start, end);

            notesToDisplay.forEach((note, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'grid-item';
                const randomRotation = Math.random() * 4 - 2;
                itemDiv.style.transform = `translateY(30px) rotate(${randomRotation}deg)`;

                const img = document.createElement('img');
                img.src = note.data;
                img.loading = 'lazy';
                img.onclick = () => viewNote(note.data);
                itemDiv.appendChild(img);

                if (isAdmin) {
                    // Add Delete Button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'admin-action-button delete-button';
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.title = 'Hapus pesan ini';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteNote(note.id);
                    };
                    itemDiv.appendChild(deleteBtn);

                    // Add Export Button
                    const exportBtn = document.createElement('button');
                    exportBtn.className = 'admin-action-button export-button';
                    exportBtn.title = 'Ekspor gambar ini';
                    exportBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
                    exportBtn.onclick = (e) => {
                        e.stopPropagation();
                        exportSingleImage(note.data, note.id);
                    };
                    itemDiv.appendChild(exportBtn);
                }
                
                gallery.appendChild(itemDiv);
                setTimeout(() => {
                    itemDiv.classList.add('visible');
                    itemDiv.style.transform = `translateY(0) rotate(${randomRotation}deg)`;
                }, index * 50);
            });

            if (pageCount > 1) {
                for (let i = 0; i < pageCount; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'pagination-dot';
                    if (i === currentPage) dot.classList.add('active');
                    dot.onclick = () => goToPage(i);
                    paginationDotsContainer.appendChild(dot);
                }
            } else {
                paginationDotsContainer.style.display = 'none';
            }
            startSlideshow(allNotes.length);
        }

        // --- Slideshow and Navigation ---
        function startSlideshow(noteCount) {
            clearInterval(slideshowInterval);
            const pageCount = Math.ceil(noteCount / NOTES_PER_PAGE);
            if (pageCount > 1 && !isAdmin) {
                slideshowInterval = setInterval(nextSlideshowPage, SLIDESHOW_DELAY);
            }
        }

        async function goToPage(pageNumber) {
            currentPage = pageNumber;
            await renderPage();
        }

        async function nextSlideshowPage() {
            const allNotes = await fetchNotes();
            const pageCount = Math.ceil(allNotes.length / NOTES_PER_PAGE);
            if (pageCount > 1) currentPage = (currentPage + 1) % pageCount;
            await renderPage();
        }

        // --- UI Modals and Toasts ---
        function viewNote(dataURL) { clearInterval(slideshowInterval); hideIdleScreen(false); modalImg.src = dataURL; modalView.classList.remove('hidden'); modalView.classList.add('flex'); requestAnimationFrame(() => { modalView.style.opacity = 1; }); }
        function closeModal() { modalView.style.opacity = 0; setTimeout(() => { modalView.classList.add('hidden'); modalView.classList.remove('flex'); renderPage(); resetIdleTimer(); }, 300); }
        function resetIdleTimer() { clearTimeout(idleTimer); idleTimer = setTimeout(showIdleScreen, IDLE_TIMEOUT); }
        function hideIdleScreen(resetTimer = true) { idleScreen.classList.add('opacity-0', 'pointer-events-none'); if (resetTimer) resetIdleTimer(); }
        function showIdleScreen() { if (!isAdmin) idleScreen.classList.remove('opacity-0', 'pointer-events-none'); }
        function showThankYouToast() { thankYouToast.classList.remove('opacity-0', '-translate-y-20'); setTimeout(() => { thankYouToast.classList.add('opacity-0', '-translate-y-20'); }, 3000); }

        // --- Canvas Logic ---
        async function submitNote() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            const tempCanvas = document.createElement('canvas'); const tempCtx = tempCanvas.getContext('2d'); tempCanvas.width = canvas.width; tempCanvas.height = canvas.height; tempCtx.fillStyle = 'white'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); tempCtx.drawImage(canvas, 0, 0);
            const dataURL = tempCanvas.toDataURL('image/png');
            try {
                const response = await fetch('/api/notes', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ note: dataURL })
                });
                if (!response.ok) throw new Error('Gagal menyimpan');
                closeCanvasView();
                showThankYouToast();
            } catch (error) { alert("Gagal menyimpan pesan."); } finally { submitBtn.disabled = false; }
        }
        
        function openCanvasView() {
            clearInterval(slideshowInterval);
            hideIdleScreen();
            canvasContainer.classList.remove('hidden');
            gallerySection.style.opacity = '0';
            bottomControls.classList.add('hidden');
            toolbar.classList.add('visible');
            requestAnimationFrame(() => {
                resizeCanvas();
                clearCanvas();
            });
        }
        function closeCanvasView() {
            canvasContainer.classList.add('hidden');
            gallerySection.style.opacity = '1';
            bottomControls.classList.remove('hidden');
            toolbar.classList.remove('visible');
            renderPage();
            resetIdleTimer();
        }
        
        // --- Drawing Functions ---
        const undoBtn = document.querySelector('#undo-btn');
        const clearBtn = document.querySelector('#clear-canvas-btn');
        function resizeCanvas() { const rect = canvas.getBoundingClientRect(); canvas.width = rect.width; canvas.height = rect.height; restoreState(); }
        function getPos(e) { const rect = canvas.getBoundingClientRect(); const touch = e.touches ? e.touches[0] : e; return { x: touch.clientX - rect.left, y: touch.clientY - rect.top }; }
        function startDrawing(e) { e.preventDefault(); drawing = true; const pos = getPos(e); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function draw(e) { if (!drawing) return; e.preventDefault(); const pos = getPos(e); ctx.lineWidth = brushSize; ctx.lineCap = 'round'; ctx.strokeStyle = brushColor; ctx.lineTo(pos.x, pos.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        function stopDrawing() { if (!drawing) return; drawing = false; ctx.beginPath(); saveState(); }
        function saveState() { historyStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height)); }
        function restoreState() { if (historyStack.length > 0) ctx.putImageData(historyStack[historyStack.length - 1], 0, 0); else ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function undo() { if (historyStack.length > 0) { historyStack.pop(); restoreState(); } }
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); historyStack = []; }
        function setBrushColor(color) { brushColor = color; }
        function setBrushSize(size) { brushSize = size; }

        // --- Initial Setup & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPage();
            // Setup toolbars
            const colorPaletteContainer = document.getElementById('color-palette');
            const brushSizesContainer = document.getElementById('brush-sizes');
            const colors = ['#000000', '#FFFFFF', '#ef4444', '#3b82f6', '#22c55e', '#f97316', '#eab308'];
            const brushSizes = [{ size: 5, display: '12px' }, { size: 10, display: '20px' }, { size: 20, display: '28px' }, { size: 40, display: '36px' }];
            colors.forEach(color => {
                const swatch = document.createElement('button');
                swatch.className = 'color-swatch';
                swatch.innerHTML = `<span style="background-color: ${color};"></span>`;
                swatch.onclick = () => setBrushColor(color);
                colorPaletteContainer.appendChild(swatch);
            });
            brushSizes.forEach(brush => {
                const button = document.createElement('button');
                button.className = 'tool-button brush-size-button';
                button.innerHTML = `<span style="width:${brush.display}; height:${brush.display};"></span>`;
                button.onclick = () => setBrushSize(brush.size);
                brushSizesContainer.appendChild(button);
            });
        });
        
        openCanvasBtn.addEventListener('click', openCanvasView);
        document.getElementById('close-canvas-btn').addEventListener('click', closeCanvasView);
        document.getElementById('submit-btn').addEventListener('click', submitNote);
        undoBtn.addEventListener('click', undo);
        clearBtn.addEventListener('click', clearCanvas);
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false }); canvas.addEventListener('touchmove', draw, { passive: false }); canvas.addEventListener('touchend', stopDrawing);
        ['click', 'mousedown', 'mousemove', 'touchstart'].forEach(evt => document.body.addEventListener(evt, resetIdleTimer));
    </script>
</body>
</html>
